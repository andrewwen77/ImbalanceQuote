<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç®¡æå®šä»·ä¼˜åŒ–ï¼ˆçº¯å‰ç«¯ç‰ˆï¼‰</title>
<!-- UI: PicoCSS æç®€æ ·å¼ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<!-- CSV è§£æ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- çº¿æ€§è§„åˆ’æ±‚è§£å™¨ï¼šjavascript-lp-solverï¼ˆçº¯ JSï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver@0.4.24/prod/solver.js"></script>
<style>
  body { max-width: 1200px; margin: 0 auto; padding: 1rem; }
  .muted { color: #666; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  table { font-size: 0.95rem; }
  th, td { white-space: nowrap; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
  .scroll-x { overflow-x: auto; }
  .warn { color: #b84; }
  .ok { color: #2a7; }
  .err { color: #c33; }
  .chip { background:#eef; padding:.2rem .5rem; border-radius:.6rem; font-size:.85rem; }
</style>
</head>
<body>

<main>
  <h2>ğŸ› ï¸ ç®¡æå®šä»·ä¼˜åŒ–ï¼ˆçº¯å‰ç«¯ / GitHub Pages å¯ç”¨ï¼‰</h2>
  <p class="muted">
    ç›®æ ‡ï¼šæœ€å¤§åŒ– <span class="mono">âˆ‘(å›¾çº¸é‡ Ã— (ç³»æ•°2å•ä»· âˆ’ æˆæœ¬))</span>ï¼ˆä»¥ã€Œæˆæœ¬ã€ä¸ºåŸºçº¿ï¼‰ã€‚<br>
    çº¦æŸï¼šæŠ¥è¡¨è¯¯å·® â‰¤ é˜ˆå€¼ï¼›ä»·æ ¼å•è°ƒä¸é™ï¼›<span class="mono">p<sub>i</sub> â‰¤</span> ä¸‹ä¸€æ¡£ç»Ÿä¸€ä»·ï¼›<span class="mono">p<sub>i</sub> â‰¥</span> æ¯è¡Œæœ€ä½ç³»æ•°2å•ä»·ï¼ˆæˆ–å…¨å±€æœ€ä½ï¼‰ï¼›ï¼ˆå¯é€‰ï¼‰ä¸ä½äºæˆæœ¬ã€‚
  </p>

  <details>
    <summary>æ•°æ®åˆ—è¯´æ˜ä¸ç¤ºä¾‹</summary>
    <ul>
      <li>å¿…éœ€åˆ—ï¼š<b>é¡¹ç›®åç§°</b>ã€<b>æ¸…å•æ•°é‡</b>ã€<b>å›¾çº¸æ•°é‡</b>ã€<b>ç»Ÿä¸€ç³»æ•°å•ä»·</b></li>
      <li>å¯é€‰åˆ—ï¼šè®¡é‡å•ä½ã€æˆæœ¬å•ä»·ã€æœ€ä½ç³»æ•°2å•ä»·ï¼ˆç¼ºå¤±æ—¶å¯ç”¨å…¨å±€å…œåº•ï¼‰</li>
      <li>é¡¹ç›®åç§°è‹¥åŒ…å«â€œDNxxxâ€ï¼Œä¼šæŒ‰ DN æ•°å­—å‡åºè‡ªåŠ¨æ’åº</li>
    </ul>
    <p class="mono chip">CSV ç¼–ç ç”¨ UTF-8 æœ€ç¨³ï¼›å¦‚æœæ˜¯ GBK ä¹Ÿä¼šè‡ªåŠ¨å°è¯•è§£æã€‚</p>
  </details>

  <hr>

  <section class="grid-2">
    <div>
      <h4>â‘  ä¸Šä¼  CSV</h4>
      <input type="file" id="file" accept=".csv" />
      <p class="muted">æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è½½å…¥å†…ç½®ç¤ºä¾‹</p>
      <button id="loadDemo" class="secondary">è½½å…¥ç¤ºä¾‹æ•°æ®</button>
    </div>

    <div>
      <h4>â‘¡ å‚æ•°è®¾ç½®</h4>
      <div class="grid-3">
        <label>æŠ¥è¡¨æ¯›åˆ©è¯¯å·®ä¸Šé™ï¼ˆå…ƒï¼‰
          <input type="number" id="tol" value="1000" step="100" min="0">
        </label>
        <label>å…¨å±€æœ€ä½ç³»æ•°2å•ä»·ï¼ˆå…œåº•ï¼‰
          <input type="number" id="globalMinP" value="0" step="0.01" min="0">
        </label>
        <label>å…¨å±€æˆæœ¬å•ä»·ï¼ˆå…œåº•ï¼‰
          <input type="number" id="globalCost" value="0" step="0.01" min="0">
        </label>
      </div>
      <label><input type="checkbox" id="enforceCost"> å¯ç”¨æˆæœ¬çº¦æŸï¼ˆp_i ä¸ä½äºæˆæœ¬ï¼‰</label>
    </div>
  </section>

  <div style="margin-top:1rem;">
    <button id="solve" class="contrast">ğŸš€ è¿è¡Œä¼˜åŒ–</button>
    <span id="status" class="muted" style="margin-left:1rem;"></span>
  </div>

  <hr>

  <h4>ğŸ“¥ è¾“å…¥æ•°æ®é¢„è§ˆ</h4>
  <div class="scroll-x">
    <table id="inputTable"></table>
  </div>

  <h4 style="margin-top:1.5rem;">ğŸ“¤ ä¼˜åŒ–ç»“æœ</h4>
  <div class="grid-3">
    <article><header>çœŸå®æ¯›åˆ©æå‡</header><strong id="uplift">-</strong></article>
    <article><header>æŠ¥è¡¨æ¯›åˆ©åå·® (â‰¤ é˜ˆå€¼)</header><strong id="reportedDiff">-</strong></article>
    <article><header>æ±‚è§£çŠ¶æ€</header><strong id="solveStatus">-</strong></article>
  </div>

  <div class="scroll-x" style="margin-top:1rem;">
    <table id="outputTable"></table>
  </div>

  <button id="downloadCsv" class="secondary" style="margin-top:1rem;" disabled>ä¸‹è½½ç»“æœ CSV</button>

</main>

<script>
// ====== å·¥å…·ï¼šCSV è§£æï¼ˆå¤šç¼–ç å…œåº•ï¼‰ ======
function parseCSV(file, cb) {
  const tryParse = (encoding, next) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      encoding,
      complete: results => {
        // å¦‚æœå…¨æ˜¯ç©ºå¯¹è±¡ï¼Œè§†ä¸ºå¤±è´¥
        const rows = results.data || [];
        const hasData = rows.some(r => Object.values(r).some(v => (v ?? "").toString().trim() !== ""));
        if (hasData) cb(null, rows);
        else next();
      },
      error: () => next()
    });
  };
  tryParse("utf-8", () => tryParse("gbk", () => tryParse("latin1", () => cb(new Error("æ— æ³•è§£æ CSV"), null))));
}

// ====== å·¥å…·ï¼šDN è§£æ & æ’åº ======
function parseDN(str) {
  const m = String(str || "").match(/DN\s*([0-9]+)/i);
  return m ? parseInt(m[1], 10) : null;
}
function sortByDN(rows) {
  const withDN = rows.map((r, i) => ({ idx: i, dn: parseDN(r["é¡¹ç›®åç§°"]), row: r }));
  const hasAny = withDN.some(x => x.dn !== null);
  if (!hasAny) return rows;
  withDN.sort((a, b) => (a.dn ?? Infinity) - (b.dn ?? Infinity));
  return withDN.map(x => x.row);
}

// ====== å·¥å…·ï¼šæ¸²æŸ“è¡¨æ ¼ ======
function renderTable(tableEl, rows, columns) {
  tableEl.innerHTML = "";
  if (!rows || rows.length === 0) { tableEl.innerHTML = "<tr><td class='muted'>æ— æ•°æ®</td></tr>"; return; }
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  columns.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tableEl.appendChild(thead);

  const tbody = document.createElement("tbody");
  rows.forEach(r => {
    const tr = document.createElement("tr");
    columns.forEach(c => {
      const td = document.createElement("td");
      const v = r[c];
      td.textContent = (v === undefined || v === null) ? "" : v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tableEl.appendChild(tbody);
}

// ====== è¯»å–/å‡†å¤‡æ•°æ® ======
const REQUIRED = ["é¡¹ç›®åç§°","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·"];
const OPTIONAL = ["è®¡é‡å•ä½","æˆæœ¬å•ä»·","æœ€ä½ç³»æ•°2å•ä»·"];

let inputRows = [];   // åŸå§‹è¾“å…¥
let outputRows = [];  // ç»“æœ

const demoRows = [
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN150","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":21.06,"å›¾çº¸æ•°é‡":70.26,"ç»Ÿä¸€ç³»æ•°å•ä»·":16.42},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN200","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":130.74,"å›¾çº¸æ•°é‡":1718.58,"ç»Ÿä¸€ç³»æ•°å•ä»·":20.45},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN300","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":9622.91,"å›¾çº¸æ•°é‡":8974.31,"ç»Ÿä¸€ç³»æ•°å•ä»·":33.85},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN400","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":1628.36,"å›¾çº¸æ•°é‡":1741.75,"ç»Ÿä¸€ç³»æ•°å•ä»·":56.27},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN500","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":512.81,"å›¾çº¸æ•°é‡":510.75,"ç»Ÿä¸€ç³»æ•°å•ä»·":77.61},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN600","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":861.04,"å›¾çº¸æ•°é‡":876.10,"ç»Ÿä¸€ç³»æ•°å•ä»·":105.22},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN800","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":656.34,"å›¾çº¸æ•°é‡":650.10,"ç»Ÿä¸€ç³»æ•°å•ä»·":328.92},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN1000","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":342.51,"å›¾çº¸æ•°é‡":297.17,"ç»Ÿä¸€ç³»æ•°å•ä»·":353.33},
  {"é¡¹ç›®åç§°":"HDPEåŒå£æ³¢çº¹ç®¡ DN1200","è®¡é‡å•ä½":"m","æ¸…å•æ•°é‡":342.54,"å›¾çº¸æ•°é‡":322.94,"ç»Ÿä¸€ç³»æ•°å•ä»·":1481.82}
];

function normalizeNumbers(rows) {
  return rows.map(r => {
    const o = { ...r };
    // æŠŠå…¨è§’/é€—å·å»æ‰
    for (const k of ["æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æˆæœ¬å•ä»·","æœ€ä½ç³»æ•°2å•ä»·"]) {
      if (o[k] !== undefined) {
        const s = String(o[k]).replace(/,/g,"").replace(/\s+/g,"");
        const v = parseFloat(s);
        o[k] = isNaN(v) ? null : v;
      }
    }
    return o;
  });
}

function ensureColumns(rows) {
  // è¡¥é½å¯é€‰åˆ—ï¼›è®¡é‡å•ä½é»˜è®¤ä¸º "m"
  return rows.map(r => ({
    "é¡¹ç›®åç§°": r["é¡¹ç›®åç§°"],
    "è®¡é‡å•ä½": r["è®¡é‡å•ä½"] ?? "m",
    "æ¸…å•æ•°é‡": r["æ¸…å•æ•°é‡"],
    "å›¾çº¸æ•°é‡": r["å›¾çº¸æ•°é‡"],
    "ç»Ÿä¸€ç³»æ•°å•ä»·": r["ç»Ÿä¸€ç³»æ•°å•ä»·"],
    "æˆæœ¬å•ä»·": r["æˆæœ¬å•ä»·"] ?? null,
    "æœ€ä½ç³»æ•°2å•ä»·": r["æœ€ä½ç³»æ•°2å•ä»·"] ?? null
  }));
}

function validateRequired(rows) {
  const has = c => rows.every(r => r.hasOwnProperty(c));
  for (const c of REQUIRED) {
    if (!has(c)) throw new Error(`ç¼ºå°‘å¿…éœ€åˆ—ï¼š${c}`);
  }
}

// ====== æ„å»º LP å¹¶æ±‚è§£ï¼ˆjavascript-lp-solverï¼‰ ======
function solveLP(rows, tol, globalMinP, globalCost, enforceCost) {
  const n = rows.length;
  if (!n) throw new Error("è¡¨æ ¼ä¸ºç©º");

  // å–å‘é‡
  const listQty = rows.map(r => +r["æ¸…å•æ•°é‡"] || 0);
  const drawQty = rows.map(r => +r["å›¾çº¸æ•°é‡"] || 0);
  const uprice  = rows.map(r => +r["ç»Ÿä¸€ç³»æ•°å•ä»·"] || 0);

  // æˆæœ¬ï¼šé€è¡Œä¼˜å…ˆï¼Œå…¶æ¬¡å…¨å±€ï¼ˆè‹¥å…¨å±€<=0ä¸”é€è¡Œä¹Ÿç¼ºï¼ŒæŠ¥é”™ï¼‰
  let cost = rows.map((r,i) => {
    const c = r["æˆæœ¬å•ä»·"];
    return (c !== null && !isNaN(+c)) ? +c : (globalCost>0 ? +globalCost : NaN);
  });
  if (cost.some(v => isNaN(v))) {
    throw new Error("å¿…é¡»æä¾›é€è¡Œã€æˆæœ¬å•ä»·ã€‘æˆ–è®¾ç½®ã€å…¨å±€æˆæœ¬å•ä»·ã€‘> 0");
  }

  // æœ€ä½ç³»æ•°2å•ä»·ï¼šé€è¡Œä¼˜å…ˆï¼Œå…¶æ¬¡å…¨å±€
  let minp = rows.map((r,i) => {
    const m = r["æœ€ä½ç³»æ•°2å•ä»·"];
    return (m !== null && !isNaN(+m)) ? +m : +globalMinP;
  });

  // ç›®æ ‡ï¼šmaximize âˆ‘ drawQty[i] * (p_i - cost[i]) = âˆ‘ drawQty[i]*p_i + å¸¸æ•°
  // åœ¨ javascript-lp-solver ä¸­ï¼Œç›®æ ‡åªéœ€è¦å˜é‡ç³»æ•°ï¼Œå¸¸æ•°é¡¹å¿½ç•¥
  const model = {
    optimize: "obj",
    opType: "max",
    constraints: {},
    variables: {},
    ints: {} // å…¨è¿ç»­å³å¯ï¼Œä¸æŒ‡å®š
  };

  // å˜é‡å®šä¹‰ & ç›®æ ‡ç³»æ•°
  // çº¦æŸå°†ç»Ÿä¸€é€šè¿‡ constraints çš„å‘½åæ¥ç»„åˆ
  // reported_upper: âˆ‘ listQty[i]*p_i <= reported_base + tol
  const reportedBase = listQty.reduce((s, q, i) => s + q * uprice[i], 0);
  model.constraints["reported_upper"] = { "max": reportedBase + tol };
  // reported_lower: -âˆ‘ listQty[i]*p_i <= tol - reportedBase
  model.constraints["reported_lower"] = { "max": tol - reportedBase };

  // å•è°ƒä¸é™ï¼šp_{i-1} - p_i <= 0  ï¼ˆi=1..n-1ï¼‰
  for (let i = 1; i < n; i++) {
    model.constraints[`mono_${i}`] = { "max": 0 };
  }
  // ä¸Šé™ï¼šp_i <= uprice[i+1]   ï¼ˆi=0..n-2ï¼‰
  for (let i = 0; i < n-1; i++) {
    model.constraints[`cap_${i}`] = { "max": uprice[i+1] };
  }
  // ä¸‹é™ï¼š-p_i <= -minp[i]  => p_i >= minp[i]
  for (let i = 0; i < n; i++) {
    model.constraints[`floor_${i}`] = { "max": -minp[i] };
  }
  // ï¼ˆå¯é€‰ï¼‰æˆæœ¬çº¦æŸï¼šp_i >= cost[i]  => -p_i <= -cost[i]
  if (enforceCost) {
    for (let i = 0; i < n; i++) {
      model.constraints[`cost_${i}`] = { "max": -cost[i] };
    }
  }

  // æ¯ä¸ªå˜é‡çš„ç³»æ•°æ„å»º
  for (let i = 0; i < n; i++) {
    const name = `p_${i}`;
    const v = { obj: drawQty[i] }; // ç›®æ ‡ç³»æ•°
    // æŠ¥è¡¨çº¦æŸ
    v["reported_upper"] = listQty[i];     // + listQty[i] * p_i
    v["reported_lower"] = -listQty[i];    // - listQty[i] * p_i
    // å•è°ƒï¼šp_{i-1} - p_i <= 0
    if (i > 0) v[`mono_${i}`] = -1;       // - p_i
    if (i > 0) {
      // ç»™å‰ä¸€ä¸ªå˜é‡åœ¨ mono_i ä¸­ +1
      // æ— æ³•åœ¨æ­¤å¤„ç»™â€œå‰ä¸€ä¸ªå˜é‡â€èµ‹ç³»æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç¨åè¡¥
    }
    // ä¸Šé™ï¼šp_i <= uprice[i+1]
    if (i < n-1) v[`cap_${i}`] = 1;
    // ä¸‹é™ï¼š-p_i <= -minp[i]
    v[`floor_${i}`] = -1;
    // æˆæœ¬
    if (enforceCost) v[`cost_${i}`] = -1;

    model.variables[name] = v;
  }
  // è¡¥é½â€œå•è°ƒçº¦æŸâ€é‡Œå¯¹å‰ä¸€é¡¹çš„ +1
  // åœ¨ solver.js çš„å»ºæ¨¡é‡Œï¼Œç³»æ•°æ˜¯ä»¥å˜é‡ä¸ºä¸­å¿ƒç™»è®°åˆ°çº¦æŸåä¸Šçš„
  // å› æ­¤æˆ‘ä»¬éœ€è¦ç»™ p_{i-1} åœ¨ mono_i çº¦æŸä¸Š +1
  for (let i = 1; i < n; i++) {
    const prev = `p_${i-1}`;
    model.variables[prev][`mono_${i}`] = (model.variables[prev][`mono_${i}`] || 0) + 1;
  }

  // è¿è¡Œæ±‚è§£
  const result = solver.Solve(model);

  if (!result.feasible) {
    throw new Error("æ— å¯è¡Œè§£ï¼ˆè¯·æ£€æŸ¥è¯¯å·®é˜ˆå€¼ã€ä¸‹é™ã€æˆæœ¬ç­‰å‚æ•°æ˜¯å¦è¿‡äºä¸¥æ ¼ï¼‰");
  }

  // ç»„è£…ç»“æœ
  const optP = Array.from({length:n}, (_,i) => result[`p_${i}`]);
  const rowsOut = rows.map((r, i) => {
    const p = +optP[i];
    const jq = +r["å›¾çº¸æ•°é‡"] || 0;
    const lq = +r["æ¸…å•æ•°é‡"] || 0;
    const up = +r["ç»Ÿä¸€ç³»æ•°å•ä»·"] || 0;
    const c  = +cost[i];

    return {
      "é¡¹ç›®åç§°": r["é¡¹ç›®åç§°"],
      "è®¡é‡å•ä½": r["è®¡é‡å•ä½"] ?? "m",
      "æ¸…å•æ•°é‡": lq,
      "å›¾çº¸æ•°é‡": jq,
      "ç»Ÿä¸€ç³»æ•°å•ä»·": up,
      "æ¸…å•é‡*ç»Ÿä¸€ç³»æ•°å•ä»·": lq * up,       // æŠ¥è¡¨å£å¾„ä»éœ€
      "ç³»æ•°2å•ä»·": p,
      "å›¾çº¸é‡*æˆæœ¬": jq * c,
      "å›¾çº¸é‡*ç³»æ•°2å•ä»·": jq * p,
      "æ¸…å•é‡*ç³»æ•°2å•ä»·": lq * p
    };
  });

  // æ±‡æ€»æŒ‡æ ‡
  const uplift = rowsOut.reduce((s, r) => s + (r["å›¾çº¸é‡*ç³»æ•°2å•ä»·"] - r["å›¾çº¸é‡*æˆæœ¬"]), 0);
  const reportedDiff = rowsOut.reduce((s, r) => s + (r["æ¸…å•é‡*ç³»æ•°2å•ä»·"] - r["æ¸…å•é‡*ç»Ÿä¸€ç³»æ•°å•ä»·"]), 0);

  return { rowsOut, uplift, reportedDiff, status: "Optimal" };
}

// ====== äº‹ä»¶ï¼šè½½å…¥ç¤ºä¾‹ ======
document.getElementById("loadDemo").addEventListener("click", () => {
  inputRows = ensureColumns(normalizeNumbers(sortByDN(demoRows)));
  renderTable(document.getElementById("inputTable"), inputRows, ["é¡¹ç›®åç§°","è®¡é‡å•ä½","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æˆæœ¬å•ä»·","æœ€ä½ç³»æ•°2å•ä»·"]);
  document.getElementById("status").textContent = "å·²è½½å…¥ç¤ºä¾‹æ•°æ®";
});

// ====== äº‹ä»¶ï¼šä¸Šä¼  CSV ======
document.getElementById("file").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) return;
  parseCSV(f, (err, rows) => {
    if (err) { alert(err.message || "CSV è§£æå¤±è´¥"); return; }
    try {
      rows = normalizeNumbers(rows);
      validateRequired(rows);
      rows = ensureColumns(rows);
      rows = sortByDN(rows);
      inputRows = rows;
      renderTable(document.getElementById("inputTable"), rows, ["é¡¹ç›®åç§°","è®¡é‡å•ä½","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æˆæœ¬å•ä»·","æœ€ä½ç³»æ•°2å•ä»·"]);
      document.getElementById("status").textContent = "CSV å·²è½½å…¥";
    } catch (e) {
      alert(e.message);
    }
  });
});

// ====== äº‹ä»¶ï¼šæ±‚è§£ ======
document.getElementById("solve").addEventListener("click", () => {
  try {
    if (!inputRows.length) {
      // é»˜è®¤ç”¨ç¤ºä¾‹
      inputRows = ensureColumns(normalizeNumbers(sortByDN(demoRows)));
      renderTable(document.getElementById("inputTable"), inputRows, ["é¡¹ç›®åç§°","è®¡é‡å•ä½","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æˆæœ¬å•ä»·","æœ€ä½ç³»æ•°2å•ä»·"]);
    }
    const tol = parseFloat(document.getElementById("tol").value) || 0;
    const globalMinP = parseFloat(document.getElementById("globalMinP").value) || 0;
    const globalCost = parseFloat(document.getElementById("globalCost").value) || 0;
    const enforceCost = document.getElementById("enforceCost").checked;

    const { rowsOut, uplift, reportedDiff, status } =
      solveLP(inputRows, tol, globalMinP, globalCost, enforceCost);

    outputRows = rowsOut;
    renderTable(
      document.getElementById("outputTable"),
      rowsOut,
      ["é¡¹ç›®åç§°","è®¡é‡å•ä½","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æ¸…å•é‡*ç»Ÿä¸€ç³»æ•°å•ä»·","ç³»æ•°2å•ä»·","å›¾çº¸é‡*æˆæœ¬","å›¾çº¸é‡*ç³»æ•°2å•ä»·","æ¸…å•é‡*ç³»æ•°2å•ä»·"]
    );

    // æŒ‡æ ‡æ˜¾ç¤º
    document.getElementById("uplift").textContent = uplift.toFixed(2);
    document.getElementById("reportedDiff").textContent = reportedDiff.toFixed(2);
    document.getElementById("solveStatus").textContent = status;
    document.getElementById("status").textContent = "æ±‚è§£æˆåŠŸ";
    document.getElementById("downloadCsv").disabled = false;

  } catch (e) {
    document.getElementById("status").textContent = "æ±‚è§£å¤±è´¥";
    document.getElementById("solveStatus").textContent = "Infeasible";
    document.getElementById("downloadCsv").disabled = true;
    alert(e.message || e);
  }
});

// ====== äº‹ä»¶ï¼šä¸‹è½½ CSV ======
document.getElementById("downloadCsv").addEventListener("click", () => {
  if (!outputRows.length) return;
  const headers = ["é¡¹ç›®åç§°","è®¡é‡å•ä½","æ¸…å•æ•°é‡","å›¾çº¸æ•°é‡","ç»Ÿä¸€ç³»æ•°å•ä»·","æ¸…å•é‡*ç»Ÿä¸€ç³»æ•°å•ä»·","ç³»æ•°2å•ä»·","å›¾çº¸é‡*æˆæœ¬","å›¾çº¸é‡*ç³»æ•°2å•ä»·","æ¸…å•é‡*ç³»æ•°2å•ä»·"];
  const csv = [headers.join(",")].concat(
    outputRows.map(r => headers.map(h => r[h] ?? "").join(","))
  ).join("\n");
  const blob = new Blob(["\ufeff"+csv], {type: "text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ä¼˜åŒ–æ˜ç»†.csv";
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
