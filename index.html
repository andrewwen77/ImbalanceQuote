<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>不平衡报价助手</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver@0.4.24/prod/solver.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{max-width:1200px;margin:0 auto;padding:1rem;}
  h2{margin-bottom:.2rem}
  .muted{color:#6b7280}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
  .sheet{overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem}
  table{border-collapse:separate;border-spacing:0;table-layout:auto;min-width:1000px}
  th,td{white-space:nowrap;padding:.4rem .6rem}
  td.col-name, th.col-name {white-space: normal;}
  table input[type="number"]{width:140px; text-align:right;}
  table input[type="text"]{width:100%; min-width:360px;}
  .w-sm{width:140px}
  .chip{background:#eef;padding:.2rem .5rem;border-radius:.6rem;font-size:.85rem}
  #outTable td:first-child, #outTable th:first-child{white-space: normal; min-width: 360px;}
</style>
</head>
<body>

<main>
  <h2>不平衡报价助手</h2>
  <p class="muted">
    报价偏差 = 清单量×建议报价 − 清单量×统一价<br>
    真实利润 = 图纸量×建议报价 − 图纸量×成本单价<br>
    <br>
    算法约束：<br>
    1. 在报价偏差不大于给定值前提下，追求利润最大化。<br>
    2. 大口径单价不低于小口径。<br>
    3. 某口径报价不高于【下一档口径统一价乘以自定义百分比】，比如自定义百分比为120%，则DN1000管建议报价不高于DN1200管的统一价乘120%。<br>
    4. 建议报价不低于成本单价和最低报价中的较大值，不高于统一系数单价的两倍。<br>
  </p>

<!-- 参数与上传 -->
<section id="topArea">
  <div>
    <h4>① 上传数据</h4>
    <input
      type="file"
      id="file"
      accept=".csv, .xlsx, .xls,
              application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,
              application/vnd.ms-excel"
      aria-label="上传数据"
    />
    <small class="muted">
      表头为：项目名称、清单数量、图纸数量、统一系数单价、成本单价、最低报价<br>
      ！！注意：上传内容可以比这些少，传上来再补充，但是传上来的列名称要一致，不然识别不到！！
    </small>
  </div>

  <div>
    <h4>② 规则设置</h4>
    <div class="grid-3">
      <label>报价允许差额（元）
        <input id="tol" type="number" value="1000" min="0" step="100" class="w-sm">
      </label>
      <label>自定义百分比（见算法约束3）（%）
        <input id="capPct" type="number" value="120" min="0" max="1000" step="1" class="w-sm">
      </label>
    </div>
  </div>
</section>

  <!-- 录入表 -->
  <h4 style="margin-top:1.2rem">③ 完善输入（可直接编辑，支持左右滑动）</h4>
  <div class="sheet">
    <table role="grid">
      <thead>
        <tr>
          <th>项目名称</th>
          <th>清单数量</th>
          <th>图纸数量</th>
          <th>统一系数单价</th>
          <th>成本单价</th>
          <th>最低报价</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <button id="btnAddRow" class="secondary" style="margin-top:.5rem">+ 新增一行</button>
  </div>

  <div style="margin-top:1rem">
    <button id="btnSolve" class="contrast">开始计算</button>
    <span id="hint" class="muted" style="margin-left:1rem"></span>
  </div>

  <!-- 结果展示 -->
  <h4 style="margin-top:1.5rem">④ 优化结果</h4>

  <div id="summaryCards" class="grid-3" style="display:none">
    <article><header>清单×统一价 合计</header><strong id="sumA">-</strong></article>
    <article><header>清单×报价 合计</header><strong id="sumB">-</strong></article>
    <article><header>图纸×成本单价 合计</header><strong id="sumC">-</strong></article>
  </div>
  <div id="summaryCards2" class="grid-3" style="display:none;margin-top:.75rem">
    <article><header>图纸×报价 合计</header><strong id="sumD">-</strong></article>
    <article><header>报价偏差（= ② − ①）</header><strong id="diffAB">-</strong></article>
    <article><header>真实利润（= ④ − ③）</header><strong id="profit">-</strong></article>
  </div>

  <div class="sheet" style="margin-top:1rem">
    <table id="outTable"></table>
  </div>

  <button id="btnJitter" class="secondary" style="margin-top:.5rem" disabled>改动小数点</button>

  <button id="btnDownload" class="secondary" style="margin-top:1rem" disabled>下载结果 CSV</button>
</main>

<script>
// ===== 工具 =====
function parseCSV(file, cb){
  const tryEnc=(enc,next)=>Papa.parse(file,{header:true,skipEmptyLines:true,encoding:enc,
    complete:r=>{const rows=r.data||[];const ok=rows.some(x=>Object.values(x).some(v=>(v??"").toString().trim()!=="")); if(ok)cb(null,rows); else next();},
    error:()=>next()});
  tryEnc("utf-8",()=>tryEnc("gbk",()=>tryEnc("latin1",()=>cb(new Error("无法解析CSV"),null))));
}
function parseXLSX(file, cb){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval: "", raw: true});
      cb(null, rows);
    }catch(err){
      cb(err, null);
    }
  };
  reader.onerror = ()=>cb(new Error("读取 Excel 失败"), null);
  reader.readAsArrayBuffer(file);
}
function parseDN(s){const m=String(s||"").match(/DN\s*([0-9]+)/i);return m?parseInt(m[1],10):null;}
function sortByDN(rows){const t=rows.map((r)=>({dn:parseDN(r["项目名称"]),r})); if(!t.some(x=>x.dn!==null))return rows; t.sort((a,b)=>(a.dn??1e9)-(b.dn??1e9)); return t.map(x=>x.r);}
function num(v){if(v===null||v===undefined) return null; const s=String(v).replace(/,/g,"").trim(); const x=parseFloat(s); return isNaN(x)?null:x;}
function to2(x){return (Math.round(x*100)/100).toFixed(2);}

// ===== 录入区 =====
const tbody=document.getElementById("tbody");
function rowToTr(r={}){
  const cols=["项目名称","清单数量","图纸数量","统一系数单价","成本单价","最低系数2单价"];
  const tr=document.createElement("tr");
  cols.forEach(c=>{
    const td=document.createElement("td");
    if (c === "项目名称") td.classList.add("col-name");
    
    const inp=document.createElement("input");
    inp.type=(c==="项目名称"?"text":"number");
    if (c === "项目名称") inp.classList.add("name-input");
    if (inp.type==="number"){inp.step="0.01";}
    inp.value=(r[c]??"");
    td.appendChild(inp); tr.appendChild(td);
  });
  return tr;
}

function loadRows(rows){tbody.innerHTML=""; sortByDN(rows).forEach(r=>tbody.appendChild(rowToTr(r)));}
function getRows(){
  const rows=[];
  [...tbody.querySelectorAll("tr")].forEach(tr=>{
    const t=[...tr.querySelectorAll("td input")];
    const row={
      "项目名称": t[0].value.trim(),
      "清单数量": num(t[1].value),
      "图纸数量": num(t[2].value),
      "统一系数单价": num(t[3].value),
      "成本单价": num(t[4].value),
      "最低报价": num(t[5].value)
    };
    if(row["项目名称"]) rows.push(row);
  });
  return rows;
}
document.getElementById("btnAddRow").onclick=()=>tbody.appendChild(rowToTr({}));

// 上传 CSV → 填充表格
// 上传文件 → 自动判断 CSV 或 Excel
document.getElementById("file").addEventListener("change", e=>{
  const f = e.target.files[0]; 
  if(!f) return;
  const name = (f.name || "").toLowerCase();

  const handleRows = (rows)=>{
  const fixed = rows.map(r=>({
    "项目名称": (r["项目名称"] ?? "").toString().trim(),
    "清单数量": num(r["清单数量"]),
    "图纸数量": num(r["图纸数量"]),
    "统一系数单价": num(r["统一系数单价"]),
    "成本单价": num(r["成本单价"]),
    "最低系数2单价": num(r["最低系数2单价"] ?? r["最低报价"])
  }));

  // ✅ 新增：只保留“项目名称”非空的行
  const cleaned = fixed.filter(r => r["项目名称"] !== "");

  loadRows(cleaned);
  document.getElementById("hint").textContent =
    `已导入：有效行 ${cleaned.length} 条（已自动忽略无“项目名称”的行）`;
};


  if (name.endsWith(".csv")) {
    parseCSV(f, (err, rows)=>{
      if(err){ alert(err.message); return; }
      handleRows(rows);
    });
  } else if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
    parseXLSX(f, (err, rows)=>{
      if(err){ alert(err.message || "Excel 解析失败"); return; }
      handleRows(rows);
    });
  } else {
    alert("仅支持 CSV / XLSX / XLS 文件");
  }
});

// ===== 计算（内部用线性规划，但界面不暴露数学词） =====
function buildAndSolve(rows, tol, capPct){
  const n=rows.length; if(!n) throw new Error("没有数据行");
  // 基础校验：成本不能为空
  if(rows.some(r=>r["成本单价"]===null||isNaN(r["成本单价"]))){
    throw new Error("存在空的【成本单价】，请补全后再计算。");
  }

  const listQty = rows.map(r=>+r["清单数量"]    ||0);
  const drawQty = rows.map(r=>+r["图纸数量"]    ||0);
  const uprice  = rows.map(r=>+r["统一系数单价"]||0);
  const cost    = rows.map(r=>+r["成本单价"]);
  const minpRaw = rows.map(r=>r["最低报价"]);

  // 最终下限：max(成本, 最低报价(若空则视为成本))
  const floor = rows.map((_,i)=>{
    const m = (minpRaw[i]===null||isNaN(minpRaw[i])) ? cost[i] : +minpRaw[i];
    return Math.max(cost[i], m);
  });

  // 模型
  const model={optimize:"obj",opType:"max",constraints:{},variables:{}};
  // 清单口径允许差额
  const base = listQty.reduce((s,q,i)=>s+q*uprice[i],0);
  model.constraints["rep_up"]={max:base + (+tol||0)};
  model.constraints["rep_lo"]={max:(+tol||0) - base};

  // 单价不降 & 上限（百分比×下一档统一价）
  for(let i=1;i<n;i++) model.constraints[`mono_${i}`]={max:0};
  for(let i=0;i<n-1;i++) model.constraints[`cap_${i}`]={max: (+capPct/100)*uprice[i+1] };
  // ✅ 新增：报价不得超过统一价的 2 倍
  for(let i=0;i<n;i++) {
    model.constraints[`cap2x_${i}`] = { max: 2 * uprice[i] };
  }


  // 下限：-p_i <= -floor_i
  for(let i=0;i<n;i++) model.constraints[`floor_${i}`]={max:-floor[i]};

  // 变量（目标用图纸量）
  for(let i=0;i<n;i++){
    const name=`p_${i}`; const v={obj:drawQty[i]};
    v["rep_up"]=listQty[i]; v["rep_lo"]=-listQty[i];
    if(i<n-1) v[`cap_${i}`]=1;
    v[`floor_${i}`]=-1;
    v[`cap2x_${i}`] = 1;
    model.variables[name]=v;
  }
  // 单调：p_{i-1} - p_i <= 0
  for(let i=1;i<n;i++){
    const prev=`p_${i-1}`, cur=`p_${i}`;
    model.variables[prev][`mono_${i}`]=(model.variables[prev][`mono_${i}`]||0)+1;
    model.variables[cur][`mono_${i}`]=(model.variables[cur][`mono_${i}`]||0)-1;
  }

  const res=solver.Solve(model);
  if(!res.feasible) throw new Error("当前规则下无解，请适当调大“允许差额”或“上限百分比”");

  const p=Array.from({length:n},(_,i)=>res[`p_${i}`]);

  // 输出表与合计
  const out=rows.map((r,i)=>{
    const lq=listQty[i], jq=drawQty[i], up=uprice[i], c=cost[i], pi=p[i];
    return {
      "项目名称": r["项目名称"],
      "清单数量": lq,
      "图纸数量": jq,
      "统一系数单价": up,
      "清单量*统一系数单价": lq*up,
      "建议报价": pi,
      "图纸量*成本": jq*c,
      "图纸量*建议报价": jq*pi,
      "清单量*建议报价": lq*pi
    };
  });

  const sumA = out.reduce((s,r)=>s+r["清单量*统一系数单价"],0);
  const sumB = out.reduce((s,r)=>s+r["清单量*建议报价"],0);
  const sumC = out.reduce((s,r)=>s+r["图纸量*成本"],0);
  const sumD = out.reduce((s,r)=>s+r["图纸量*建议报价"],0);

  return {out,sumA,sumB,sumC,sumD};
}

// 渲染结果表
function renderOutTable(rows){
  const tbl=document.getElementById("outTable");
  tbl.innerHTML="";
  if(!rows||!rows.length){tbl.innerHTML="<tr><td class='muted'>暂无结果</td></tr>";return;}
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本","图纸量*建议报价","清单量*建议报价"];
  const thead=document.createElement("thead"); 
  const trh=document.createElement("tr");
  headers.forEach((h,idx)=>{
    const th=document.createElement("th");
    th.textContent=h;
    if (idx===0) th.classList.add("col-name");   // ✅ 首列表头加类
    trh.appendChild(th);
  });
  thead.appendChild(trh); tbl.appendChild(thead);
  
  // 行数据
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    headers.forEach((h,idx)=>{
      const td=document.createElement("td");
      if (idx===0) td.classList.add("col-name"); // ✅ 首列单元格加类
      const v=r[h];
      td.textContent=(typeof v==="number")?to2(v):v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

// 计算按钮
document.getElementById("btnSolve").onclick=()=>{
  try{
    const rows=getRows();
    if(!rows.length){alert("请先录入或导入数据");return;}
    const tol=+document.getElementById("tol").value||0;
    const capPct=+document.getElementById("capPct").value||100;

    const {out,sumA,sumB,sumC,sumD}=buildAndSolve(rows,tol,capPct);

    document.getElementById("sumA").textContent=to2(sumA);
    document.getElementById("sumB").textContent=to2(sumB);
    document.getElementById("sumC").textContent=to2(sumC);
    document.getElementById("sumD").textContent=to2(sumD);
    document.getElementById("diffAB").textContent=to2(sumB - sumA);
    document.getElementById("profit").textContent=to2(sumD - sumC);
    document.getElementById("summaryCards").style.display="";
    document.getElementById("summaryCards2").style.display="";
    document.getElementById("hint").textContent="计算完成";

    renderOutTable(out);
    window._outRows=out; document.getElementById("btnDownload").disabled=false;
    document.getElementById("btnJitter").disabled = false;
  }catch(e){
    document.getElementById("hint").textContent=e.message||"计算失败";
    alert(e.message||e);
  }
};

// 下载 CSV
document.getElementById("btnDownload").onclick=()=>{
  const rows=window._outRows||[]; if(!rows.length)return;
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本单价","图纸量*建议报价","清单量*建议报价"];
  const csv=[headers.join(",")].concat(rows.map(r=>headers.map(h=>r[h]??"").join(","))).join("\n");
  const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="报价结果.csv"; a.click(); URL.revokeObjectURL(url);
};

// ✅ 改动小数点：对“系数2单价”加随机[-0.5, +0.5]，保留两位小数；随后就地重算汇总与表格
function jitterPrices() {
  if (!window._outRows || !window._outRows.length) {
    alert("请先完成一次计算");
    return;
  }
  // 复制一份数据避免直接修改引用（也可以原地改）
  const rows = window._outRows.map(r => ({ ...r }));

  // 随机扰动：两位小数、范围 [-0.5, +0.5]
  function randDelta() {
    // 取 [-0.5, 0.5]，两位小数
    return Math.round((Math.random() - 0.5) * 100) / 100;
  }

  // 对“系数2单价”做扰动并重算两列
  rows.forEach(r => {
    const oldP = +r["系数2单价"] || 0;
    const jq   = +r["图纸数量"]   || 0;
    const lq   = +r["清单数量"]   || 0;

    const newP = Math.round((oldP + randDelta()) * 100) / 100;  // 保留两位
    r["系数2单价"]        = newP;
    r["图纸量*系数2单价"] = jq * newP;
    r["清单量*系数2单价"] = lq * newP;
  });

  // 重新汇总（注意：此步不再校验或回到约束，仅做显示）
  const sumA = rows.reduce((s,r)=>s + (+r["清单量*统一系数单价"]||0), 0);
  const sumB = rows.reduce((s,r)=>s + (+r["清单量*系数2单价"]||0), 0);
  const sumC = rows.reduce((s,r)=>s + (+r["图纸量*成本"]||0),     0);
  const sumD = rows.reduce((s,r)=>s + (+r["图纸量*系数2单价"]||0), 0);

  // 更新摘要卡片
  document.getElementById("sumA").textContent = to2(sumA);
  document.getElementById("sumB").textContent = to2(sumB);
  document.getElementById("sumC").textContent = to2(sumC);
  document.getElementById("sumD").textContent = to2(sumD);
  document.getElementById("diffAB").textContent = to2(sumB - sumA); // 报价偏差
  document.getElementById("profit").textContent = to2(sumD - sumC); // 真实利润

  // 重绘结果表
  renderOutTable(rows);

  // 覆盖全局结果，便于后续下载 CSV
  window._outRows = rows;

  // 提示
  document.getElementById("hint").textContent = "已随机微调报价小数点";
}
document.getElementById("btnJitter").addEventListener("click", jitterPrices);
</script>

</body>
</html>














