<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>不平衡报价助手</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver@0.4.24/prod/solver.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{max-width:1600px;margin:0 auto;padding:1rem;}
  h2{margin-bottom:.2rem}
  .muted{color:#6b7280}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
  .sheet{overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem}
  table{border-collapse:separate;border-spacing:0;table-layout:auto;min-width:1100px}
  th,td{white-space:nowrap;padding:.4rem .6rem}
  td.col-name, th.col-name {white-space: normal;}
  table input[type="number"]{width:140px; text-align:right;}
  table input[type="text"]{width:100%; min-width:360px;}
  .w-sm{width:140px}
  .chip{background:#eef;padding:.2rem .5rem;border-radius:.6rem;font-size:.85rem}
  #outTable td:first-child, #outTable th:first-child{white-space: normal; min-width: 360px;}

  /* 拖拽手柄与高亮 */
  th.drag-col, td.drag-col { width: 36px; text-align:center; }
  .drag-handle { cursor: move; user-select: none; font-weight:700; }
  tr.drag-over { outline: 2px dashed #4f46e5; }

  /* —— 修复“品类”下拉选中值不可见 —— */
  th.series-col, td.series-col {
    width: 96px;
    min-width: 96px;
    text-align: center;
    white-space: nowrap;
  }
  
  /* —— 让品类下拉用我们自己的样式，收起后必定可见 —— */
  .series-select{
    /* 彻底不用 Pico 的样式 */
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
  
    /* 可见性与颜色 */
    opacity: 1 !important;
    color: #111 !important;
    background-color: #fff !important;
  
    /* 自己的边框与尺寸 */
    width: 90px;
    min-width: 90px;
    height: 2.1rem;
    line-height: 2.1rem;
    padding: 0 .75rem 0 .5rem;
    border: 1px solid #cbd5e1;
    border-radius: .375rem;
    text-align: center;       /* 兼容性更好 */
    text-align-last: center;  /* Chrome/Edge 居中 */
  
    /* 自绘下拉箭头（避免 Pico 的背景箭头把文字盖掉） */
    background-image:
      linear-gradient(45deg, transparent 50%, #666 50%),
      linear-gradient(135deg, #666 50%, transparent 50%),
      linear-gradient(to right, #ddd, #ddd);
    background-position:
      calc(100% - 14px) 50%,
      calc(100% - 8px)  50%,
      calc(100% - 2rem) 50%;
    background-size: 6px 6px, 6px 6px, 1px 1.4rem;
    background-repeat: no-repeat;
  }
  
  /* 选项文本也强制深色，防止主题覆盖 */
  .series-select option{ color:#111 !important; }
  .series-select option[value=""]{ color:#6b7280 !important; }
  
  /* 列宽 */
  th.series-col, td.series-col{
    width: 96px;
    min-width: 96px;
    text-align: center;
    white-space: nowrap;
  }



</style>
</head>
<body>

<main>
  <h2>不平衡报价助手</h2>
  <p class="muted">
    报价偏差 = 清单量×建议报价 − 清单量×统一价<br>
    真实利润 = 图纸量×建议报价 − 图纸量×成本单价<br>
    <br>
    规则摘要：<br>
    1) 在报价允许差额内最大化真实利润；<br>
    2) 同品类零部件中，按表格顺序（从上到下）设置：单价不下降；且本档建议报价 ≤ 下一档统一价 × 自定义百分比；比如自定义百分比为120%，则HDPE双壁波纹管品类中，DN1000管建议报价不高于DN1200管的统一价乘120%<br>
    3) 建议报价不低于最低报价，不高于最高报价；若没有填写最低、最高报价，则不低于成本单价，不高于统一系数单价的两倍；<br>
    4）同品类相邻两行的建议报价差价 ≥ （统一系数单价差价 × 设定百分比）。
  </p>

<!-- 参数与上传 -->
<section id="topArea">
  <div>
    <h4>① 上传数据</h4>
    <input
      type="file"
      id="file"
      accept=".csv, .xlsx, .xls,
              application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,
              application/vnd.ms-excel"
      aria-label="上传数据"
    />
    <small class="muted">
      必需列：项目名称、清单数量、图纸数量、统一系数单价、成本单价<br>
      可选列：最低报价、最高报价、品类（若无品类则不建立组内约束）
    </small>
  </div>

  <div>
    <h4>② 规则设置</h4>
    <div class="grid-3">
      <label>报价允许差额（元）
        <input id="tol" type="number" value="1000" min="0" step="100" class="w-sm">
      </label>
      <label>对下档上限（%）
        <input id="capPct" type="number" value="120" min="0" max="1000" step="1" class="w-sm">
      </label>
      <label>相邻差价下限（%×统一价差）
        <input id="gapPct" type="number" value="10" min="0" max="100" step="1" class="w-sm">
      </label>
    </div>
    <small class="muted">同一“品类”内，顺序即“从上到下”；可拖动行排序。未选择品类的行不做组内约束。</small>
  </div>
</section>

  <!-- 录入表 -->
  <h4 style="margin-top:1.2rem">③ 完善输入（可直接编辑，支持左右滑动；拖拽“≡”更改顺序）</h4>
  <div class="sheet">
    <table role="grid">
      <thead>
        <tr>
          <th class="drag-col">⇅</th>
          <th>项目名称</th>
          <th class="series-col">品类</th>
          <th>清单数量</th>
          <th>图纸数量</th>
          <th>统一系数单价</th>
          <th>成本单价</th>
          <th>最低报价</th>
          <th>最高报价</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <button id="btnAddRow" class="secondary" style="margin-top:.5rem">+ 新增一行</button>
  </div>

  <div style="margin-top:1rem">
    <button id="btnSolve" class="contrast">开始计算</button>
    <span id="hint" class="muted" style="margin-left:1rem"></span>
  </div>

  <!-- 结果展示 -->
  <h4 style="margin-top:1.5rem">④ 优化结果</h4>

  <div id="summaryCards" class="grid-3" style="display:none">
    <article><header>① 清单量×统一系数价 合计</header><strong id="sumA">-</strong></article>
    <article><header>② 清单量×建议报价 合计</header><strong id="sumB">-</strong></article>
    <article><header>③ 图纸量×成本单价 合计</header><strong id="sumC">-</strong></article>
  </div>
  <div id="summaryCards2" class="grid-3" style="display:none;margin-top:.75rem">
    <article><header>④ 图纸量×建议报价 合计</header><strong id="sumD">-</strong></article>
    <article><header>报价偏差（= ② − ①）</header><strong id="diffAB">-</strong></article>
    <article><header>真实利润（= ④ − ③）</header><strong id="profit">-</strong></article>
  </div>

  <div class="sheet" style="margin-top:1rem">
    <table id="outTable"></table>
  </div>

  <button id="btnJitter" class="secondary" style="margin-top:.5rem" disabled>改动小数点</button>

  <button id="btnDownload" class="secondary" style="margin-top:1rem" disabled>下载结果 CSV</button>
</main>

<script>
// ===== 工具 =====
function parseCSV(file, cb){
  const tryEnc=(enc,next)=>Papa.parse(file,{header:true,skipEmptyLines:true,encoding:enc,
    complete:r=>{const rows=r.data||[];const ok=rows.some(x=>Object.values(x).some(v=>(v??"").toString().trim()!=="")); if(ok)cb(null,rows); else next();},
    error:()=>next()});
  tryEnc("utf-8",()=>tryEnc("gbk",()=>tryEnc("latin1",()=>cb(new Error("无法解析CSV"),null))));
}
function parseXLSX(file, cb){
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type: 'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval: "", raw: true});
      cb(null, rows);
    }catch(err){
      cb(err, null);
    }
  };
  reader.onerror = ()=>cb(new Error("读取 Excel 失败"), null);
  reader.readAsArrayBuffer(file);
}
function num(v){if(v===null||v===undefined) return null; const s=String(v).replace(/,/g,"").trim(); const x=parseFloat(s); return isNaN(x)?null:x;}
function to2(x){return (Math.round(x*100)/100).toFixed(2);}

// ===== 录入区（拖拽 + 品类） =====
const tbody=document.getElementById("tbody");

function seriesSelect(defaultVal=""){
  const sel = document.createElement("select");
  const optBlank = document.createElement("option"); optBlank.value=""; optBlank.textContent="（无）";
  sel.appendChild(optBlank);
  for (let i=0;i<26;i++){
    const ch = String.fromCharCode(65+i); // A..Z
    const opt = document.createElement("option");
    opt.value = ch; opt.textContent = ch;
    sel.appendChild(opt);
  }
  sel.value = defaultVal || "";
  return sel;
}

function rowToTr(r={}){
  // 顺序：拖拽|项目名称|品类|清单|图纸|统一价|成本|最低|最高
  const tr=document.createElement("tr");
  tr.setAttribute("draggable","true");

  // 拖拽手柄
  const tdDrag = document.createElement("td");
  tdDrag.className = "drag-col";
  tdDrag.innerHTML = '<span class="drag-handle">≡</span>';
  tr.appendChild(tdDrag);

  // 项目名称
  let td=document.createElement("td"); td.classList.add("col-name");
  let inp=document.createElement("input"); inp.type="text"; inp.classList.add("name-input");
  inp.value=(r["项目名称"]??"");
  td.appendChild(inp); tr.appendChild(td);

  // 品类（A-Z）
  td = document.createElement("td");
  td.classList.add("series-col");
  const sel = seriesSelect(r["品类"] ?? "");
  sel.classList.add("series-select");   // 这句必须在
  td.appendChild(sel);
  tr.appendChild(td);

  // 其余数字列
  const cols=["清单数量","图纸数量","统一系数单价","成本单价","最低报价","最高报价"];
  cols.forEach(c=>{
    const td=document.createElement("td");
    const ip=document.createElement("input");
    ip.type="number"; ip.step="0.01"; ip.value=(r[c]??"");
    td.appendChild(ip); tr.appendChild(td);
  });
  return tr;
}

function enableRowDrag() {
  let dragRow = null;
  tbody.querySelectorAll("tr").forEach(tr=>{
    tr.addEventListener("dragstart", e=>{
      dragRow = tr;
      tr.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    tr.addEventListener("dragend", ()=>{
      dragRow = null;
      tr.classList.remove("dragging");
      tbody.querySelectorAll("tr").forEach(x=>x.classList.remove("drag-over"));
    });
    tr.addEventListener("dragover", e=>{
      e.preventDefault();
      const target = tr;
      if (!dragRow || dragRow===target) return;
      target.classList.add("drag-over");
      const rect = target.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      tbody.insertBefore(dragRow, before ? target : target.nextSibling);
    });
    tr.addEventListener("dragleave", ()=> tr.classList.remove("drag-over"));
    tr.addEventListener("drop", e=>{
      e.preventDefault();
      tr.classList.remove("drag-over");
    });
  });
}

function loadRows(rows){
  tbody.innerHTML="";
  rows.forEach(r=>tbody.appendChild(rowToTr(r)));
  enableRowDrag();
}
function getRows(){
  const rows=[];
  [...tbody.querySelectorAll("tr")].forEach(tr=>{
    const tds=[...tr.querySelectorAll("td")];
    const row={
      "项目名称": tds[1].querySelector("input").value.trim(),
      "品类": (tds[2].querySelector("select").value||"").trim(),
      "清单数量": num(tds[3].querySelector("input").value),
      "图纸数量": num(tds[4].querySelector("input").value),
      "统一系数单价": num(tds[5].querySelector("input").value),
      "成本单价": num(tds[6].querySelector("input").value),
      "最低报价": num(tds[7].querySelector("input").value),
      "最高报价": num(tds[8].querySelector("input").value)
    };
    if(row["项目名称"]) rows.push(row);
  });
  return rows;
}
document.getElementById("btnAddRow").onclick=()=>{ tbody.appendChild(rowToTr({})); enableRowDrag(); };

// 上传：自动判定 CSV / Excel
document.getElementById("file").addEventListener("change", e=>{
  const f = e.target.files[0]; 
  if(!f) return;
  const name = (f.name || "").toLowerCase();

  const handleRows = (rows)=>{
    const fixed = rows.map(r=>({
      "项目名称": (r["项目名称"] ?? "").toString().trim(),
      "品类": (r["品类"] ?? "").toString().trim(),
      "清单数量": num(r["清单数量"]),
      "图纸数量": num(r["图纸数量"]),
      "统一系数单价": num(r["统一系数单价"]),
      "成本单价": num(r["成本单价"]),
      "最低报价": num(r["最低报价"]),
      "最高报价": num(r["最高报价"])
    }));
    const cleaned = fixed.filter(r => r["项目名称"] !== "");
    loadRows(cleaned);
    document.getElementById("hint").textContent = `已导入：有效行 ${cleaned.length} 条（已忽略无“项目名称”的行）`;
  };

  if (name.endsWith(".csv")) {
    parseCSV(f, (err, rows)=>{ if(err){ alert(err.message); return; } handleRows(rows); });
  } else if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
    parseXLSX(f, (err, rows)=>{ if(err){ alert(err.message || "Excel 解析失败"); return; } handleRows(rows); });
  } else {
    alert("仅支持 CSV / XLSX / XLS 文件");
  }
});

// ===== 计算（线性规划，界面不暴露数学词） =====
function buildAndSolve(rows, tol, capPct, gapPct){
  const gapFrac = (+gapPct || 0) / 100;
  const n=rows.length; if(!n) throw new Error("没有数据行");
  if(rows.some(r=>r["成本单价"]===null||isNaN(r["成本单价"]))){
    throw new Error("存在空的【成本单价】，请补全后再计算。");
  }

  const listQty = rows.map(r=>+r["清单数量"]    ||0);
  const drawQty = rows.map(r=>+r["图纸数量"]    ||0);
  const uprice  = rows.map(r=>+r["统一系数单价"]||0);
  const cost    = rows.map(r=>+r["成本单价"]);
  const minpRaw = rows.map(r=>r["最低报价"]);
  const maxpRaw = rows.map(r=>r["最高报价"]);
  const series  = rows.map(r=> (r["品类"]||"").trim());

  const floor = rows.map((_,i)=>{
    const hasMin = !(minpRaw[i]===null || isNaN(minpRaw[i]));
    return hasMin ? (+minpRaw[i]) : cost[i];
  });

  const model={optimize:"obj",opType:"max",constraints:{},variables:{}};

  // 报价偏差容差（相对清单×统一价）
  const base = listQty.reduce((s,q,i)=>s+q*uprice[i],0);
  model.constraints["rep_up"]={max:base + (+tol||0)};
  model.constraints["rep_lo"]={max:(+tol||0) - base};

  // 每行上下限按照“最低/最高优先”规则添加
  for(let i=0;i<n;i++){
    const hasMin = !(minpRaw[i]===null || isNaN(minpRaw[i]));
    const hasMax = !(maxpRaw[i]===null || isNaN(maxpRaw[i]));
 
    // 下限始终存在：floor_i（见上方 floor 计算）
    model.constraints[`floor_${i}`] = { max: -floor[i] }; // -p_i <= -floor_i

    // 上限：
    // 若同时有最低&最高 => 只用 capMax，不加 cap2x
    // 若仅有最高 => capMax 与 cap2x 并存（取更紧的）
    // 若无最高 => 仅 cap2x
    if (hasMax) {
      model.constraints[`capMax_${i}`] = { max: +maxpRaw[i] };
    }
    if (!(hasMin && hasMax)) {
      // 仅在“不是(最低&最高都填)”时才引入 2×统一价上限
      model.constraints[`cap2x_${i}`] = { max: 2 * uprice[i] };
    }
  }
 
  // 变量
  for(let i=0;i<n;i++){
    const name=`p_${i}`; const v={obj:drawQty[i]};
    v["rep_up"]=listQty[i]; 
    v["rep_lo"]=-listQty[i];
    v[`floor_${i}`]=-1;          // 下限
    const hasMin = !(minpRaw[i]===null || isNaN(minpRaw[i]));
    const hasMax = !(maxpRaw[i]===null || isNaN(maxpRaw[i]));
    if (hasMax) v[`capMax_${i}`] = 1;   // 最高价
    if (!(hasMin && hasMax)) v[`cap2x_${i}`] = 1; // 2×统一（仅当没同时填高/低时）
    model.variables[name]=v;
  }

  // 仅对同品类、按“当前表格顺序”建立组内约束：单价不下降 + 对下档 cap%×统一价 上限
  const groupMap = {};
  for (let i=0;i<n;i++){
    const g = series[i] || ""; // 空串 => 不分组
    if (!groupMap[g]) groupMap[g] = [];
    groupMap[g].push(i);
  }
  let monoId = 0, capNextId = 0, gapId = 0;
  Object.entries(groupMap).forEach(([g, idxList])=>{
    if (!g || idxList.length <= 1) return; // 无品类或单行不约束
    for (let k=1;k<idxList.length;k++){
      const iPrev = idxList[k-1], iCurr = idxList[k];
      const monoName = `mono_${monoId++}`;
      model.constraints[monoName] = { max: 0 }; // p_prev - p_curr ≤ 0
      // 变量系数
      model.variables[`p_${iPrev}`][monoName] = (model.variables[`p_${iPrev}`][monoName]||0)+1;
      model.variables[`p_${iCurr}`][monoName] = (model.variables[`p_${iCurr}`][monoName]||0)-1;

      const capName = `cap_${capNextId++}`;
      model.constraints[capName] = { max: (+capPct/100) * uprice[iCurr] }; // p_prev ≤ cap% × u_next
      model.variables[`p_${iPrev}`][capName] = 1;

      if (gapFrac > 0) {
        const rhs = gapFrac * Math.max(0, uprice[iCurr] - uprice[iPrev]);
        if (rhs > 0) {
          const gapName = `gap_${gapId++}`;
          // 线性化为：p_prev - p_curr ≤ -rhs
          model.constraints[gapName] = { max: -rhs };
          model.variables[`p_${iPrev}`][gapName] = (model.variables[`p_${iPrev}`][gapName]||0) + 1;
          model.variables[`p_${iCurr}`][gapName] = (model.variables[`p_${iCurr}`][gapName]||0) - 1;
        }
      }
    }
  });

  const res=solver.Solve(model);
  if(!res.feasible) throw new Error("当前规则下无解，请适当调大“允许差额”或“对下档上限(%)”");

  const p=Array.from({length:n},(_,i)=>res[`p_${i}`]);

  // 输出表与合计
  const out=rows.map((r,i)=>{
    const lq=listQty[i], jq=drawQty[i], up=uprice[i], c=cost[i], pi=p[i];
    return {
      "项目名称": r["项目名称"],
      "清单数量": lq,
      "图纸数量": jq,
      "统一系数单价": up,
      "清单量*统一系数单价": lq*up,
      "建议报价": pi,
      "图纸量*成本单价": jq*c,
      "图纸量*建议报价": jq*pi,
      "清单量*建议报价": lq*pi
    };
  });

  const sumA = out.reduce((s,r)=>s+r["清单量*统一系数单价"],0);
  const sumB = out.reduce((s,r)=>s+r["清单量*建议报价"],0);
  const sumC = out.reduce((s,r)=>s+r["图纸量*成本单价"],0);
  const sumD = out.reduce((s,r)=>s+r["图纸量*建议报价"],0);

  return {out,sumA,sumB,sumC,sumD};
}

// 渲染结果表
function renderOutTable(rows){
  const tbl=document.getElementById("outTable");
  tbl.innerHTML="";
  if(!rows||!rows.length){tbl.innerHTML="<tr><td class='muted'>暂无结果</td></tr>";return;}
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本单价","图纸量*建议报价","清单量*建议报价"];
  const thead=document.createElement("thead"); 
  const trh=document.createElement("tr");
  headers.forEach((h,idx)=>{
    const th=document.createElement("th");
    th.textContent=h;
    if (idx===0) th.classList.add("col-name");
    trh.appendChild(th);
  });
  thead.appendChild(trh); tbl.appendChild(thead);
  
  const tbodyOut=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    headers.forEach((h,idx)=>{
      const td=document.createElement("td");
      if (idx===0) td.classList.add("col-name");
      const v=r[h];
      td.textContent=(typeof v==="number")?to2(v):v;
      tr.appendChild(td);
    });
    tbodyOut.appendChild(tr);
  });
  tbl.appendChild(tbodyOut);
}

// 计算按钮
document.getElementById("btnSolve").onclick=()=>{
  try{
    const rows=getRows();
    if(!rows.length){alert("请先录入或导入数据");return;}
    const tol=+document.getElementById("tol").value||0;
    const capPct=+document.getElementById("capPct").value||100;
    const gapPct = +document.getElementById("gapPct").value || 0;

    const {out,sumA,sumB,sumC,sumD}=buildAndSolve(rows, tol, capPct, gapPct);

    document.getElementById("sumA").textContent=to2(sumA);
    document.getElementById("sumB").textContent=to2(sumB);
    document.getElementById("sumC").textContent=to2(sumC);
    document.getElementById("sumD").textContent=to2(sumD);
    document.getElementById("diffAB").textContent=to2(sumB - sumA);
    document.getElementById("profit").textContent=to2(sumD - sumC);
    document.getElementById("summaryCards").style.display="";
    document.getElementById("summaryCards2").style.display="";
    document.getElementById("hint").textContent="计算完成";

    renderOutTable(out);
    window._outRows = out; 
    window._outRowsBase = out.map(r => ({ ...r }));  // 保存基线
    document.getElementById("btnDownload").disabled = false;
    document.getElementById("btnJitter").disabled = false;
  }catch(e){
    document.getElementById("hint").textContent=e.message||"计算失败";
    alert(e.message||e);
  }
};

// 下载 CSV
document.getElementById("btnDownload").onclick=()=>{
  const rows=window._outRows||[]; if(!rows.length)return;
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本单价","图纸量*建议报价","清单量*建议报价"];
  const csv=[headers.join(",")].concat(rows.map(r=>headers.map(h=>{
    const v=r[h]; return (typeof v==="number")?to2(v): (v??"");
  }).join(","))).join("\n");
  const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="报价结果.csv"; a.click(); URL.revokeObjectURL(url);
};

// 改动小数点：每次以“基线”抖动；若偏差不在[0,2*tol]，丢弃并回到基线
function jitterPrices() {
  if (!window._outRowsBase || !window._outRowsBase.length) {
    alert("请先点击【开始计算】得到一份基线结果");
    return;
  }
  const base = window._outRowsBase;
  const rows = base.map(r => ({ ...r }));

  function jitterFor(p) {
    const maxStep = Math.min(0.5, Math.max(0.01, Math.abs(p) * 0.02));
    const delta = (Math.random() * 2 - 1) * maxStep;
    return Math.round((p + delta) * 100) / 100;
  }

  rows.forEach(r => {
    const oldP = +r["建议报价"] || 0;
    const jq   = +r["图纸数量"] || 0;
    const lq   = +r["清单数量"] || 0;
    const newP = jitterFor(oldP);
    r["建议报价"]         = newP;
    r["图纸量*建议报价"]  = jq * newP;
    r["清单量*建议报价"]  = lq * newP;
  });

  const sumA = rows.reduce((s,r)=>s + (+r["清单量*统一系数单价"]||0), 0);
  const sumB = rows.reduce((s,r)=>s + (+r["清单量*建议报价"]||0),   0);
  const sumC = rows.reduce((s,r)=>s + (+r["图纸量*成本单价"]||0),     0);
  const sumD = rows.reduce((s,r)=>s + (+r["图纸量*建议报价"]||0),     0);

  const tol = +document.getElementById("tol").value || 0;
  const diff = sumB - sumA;
  const lower = 0, upper = 2 * tol;

  if (diff < lower || diff > upper) {
    renderOutTable(base);
    window._outRows = base.map(r => ({ ...r }));
    const bA = base.reduce((s,r)=>s + (+r["清单量*统一系数单价"]||0), 0);
    const bB = base.reduce((s,r)=>s + (+r["清单量*建议报价"]||0),   0);
    const bC = base.reduce((s,r)=>s + (+r["图纸量*成本单价"]||0),     0);
    const bD = base.reduce((s,r)=>s + (+r["图纸量*建议报价"]||0),     0);
    document.getElementById("sumA").textContent = to2(bA);
    document.getElementById("sumB").textContent = to2(bB);
    document.getElementById("sumC").textContent = to2(bC);
    document.getElementById("sumD").textContent = to2(bD);
    document.getElementById("diffAB").textContent = to2(bB - bA);
    document.getElementById("profit").textContent = to2(bD - bC);
    document.getElementById("hint").textContent = "本次随机未采用（偏差越界），已保留原优化结果";
    return;
  }

  document.getElementById("sumA").textContent = to2(sumA);
  document.getElementById("sumB").textContent = to2(sumB);
  document.getElementById("sumC").textContent = to2(sumC);
  document.getElementById("sumD").textContent = to2(sumD);
  document.getElementById("diffAB").textContent = to2(diff);
  document.getElementById("profit").textContent = to2(sumD - sumC);

  renderOutTable(rows);
  window._outRows = rows;
  document.getElementById("hint").textContent = "已随机微调报价小数位（偏差在可接受范围内）";
}
document.getElementById("btnJitter").addEventListener("click", jitterPrices);
</script>

</body>
</html>








