<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>不平衡报价助手</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/javascript-lp-solver@0.4.24/prod/solver.js"></script>

<style>
  body{max-width:1200px;margin:0 auto;padding:1rem;}
  h2{margin-bottom:.2rem}
  .muted{color:#6b7280}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
  .sheet{overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem;padding:.5rem}
  table{border-collapse:separate;border-spacing:0;table-layout:auto;min-width:1000px}
  th,td{white-space:nowrap;padding:.4rem .6rem}
  td.col-name, th.col-name {white-space: normal;}
  table input[type="number"]{width:140px; text-align:right;}
  table input[type="text"]{width:100%; min-width:360px;}
  .w-sm{width:140px}
  .chip{background:#eef;padding:.2rem .5rem;border-radius:.6rem;font-size:.85rem}
  #outTable td:first-child, #outTable th:first-child{white-space: normal; min-width: 360px;}
</style>
</head>
<body>

<main>
  <h2>不平衡报价助手</h2>
  <p class="muted">
    报价偏差 = 清单量×报价 − 清单量×统一价<br>
    真实利润 = 图纸量×报价 − 图纸量×成本价<br>
    算法约束：<br>
    1. 在报价偏差不大于给定值前提下，追求利润最大化。<br>
    2. 大口径单价不低于小口径。<br>
    3. 某口径报价不高于下一档口径统一价乘以自定义百分比，比如自定义百分比为20%，则DN1000管建议报价不高于DN1200管的统一价乘120%。<br>
    4. 建议报价不低于成本价和最低报价中的较大值。<br>
  </p>

  <!-- 参数与上传 -->
  <section class="grid-2">
    <div>
      <h4>① 上传数据</h4>
      <input type="file" id="file" accept=".csv" aria-label="上传数据"/>
      <small class="muted">
        表格必须包含：项目名称、清单数量、图纸数量、统一系数单价、成本价<br>
        可选列：最低报价
      </small>
    </div>
    <div>
      <h4>② 规则设置</h4>
      <div class="grid-3">
        <label>报价允许差额（元）
          <input id="tol" type="number" value="1000" min="0" step="100" class="w-sm">
        </label>
        <label>超下档百分比（%）
          <input id="capPct" type="number" value="100" min="1" max="1000" step="1" class="w-sm">
        </label>
      </div>
    </div>
  </section>

  <div style="margin-top:1rem">
    <button id="btnSolve" class="contrast">开始计算</button>
    <span id="hint" class="muted" style="margin-left:1rem"></span>
  </div>

  <!-- 录入表 -->
  <h4 style="margin-top:1.2rem">③ 录入区（可直接编辑，支持左右滑动）</h4>
  <div class="sheet">
    <table role="grid">
      <thead>
        <tr>
          <th>项目名称</th>
          <th>清单数量</th>
          <th>图纸数量</th>
          <th>统一系数单价</th>
          <th>成本单价</th>
          <th>最低报价</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <button id="btnAddRow" class="secondary" style="margin-top:.5rem">+ 新增一行</button>
  </div>

  <!-- 结果展示 -->
  <h4 style="margin-top:1.5rem">④ 结果</h4>

  <div id="summaryCards" class="grid-3" style="display:none">
    <article><header>清单×统一价 合计</header><strong id="sumA">-</strong></article>
    <article><header>清单×报价 合计</header><strong id="sumB">-</strong></article>
    <article><header>图纸×成本单价 合计</header><strong id="sumC">-</strong></article>
  </div>
  <div id="summaryCards2" class="grid-3" style="display:none;margin-top:.75rem">
    <article><header>图纸×报价 合计</header><strong id="sumD">-</strong></article>
    <article><header>报价偏差（= ② − ①）</header><strong id="diffAB">-</strong></article>
    <article><header>真实利润（= ④ − ③）</header><strong id="profit">-</strong></article>
  </div>

  <div class="sheet" style="margin-top:1rem">
    <table id="outTable"></table>
  </div>

  <button id="btnDownload" class="secondary" style="margin-top:1rem" disabled>下载结果 CSV</button>
</main>

<script>
// ===== 工具 =====
function parseCSV(file, cb){
  const tryEnc=(enc,next)=>Papa.parse(file,{header:true,skipEmptyLines:true,encoding:enc,
    complete:r=>{const rows=r.data||[];const ok=rows.some(x=>Object.values(x).some(v=>(v??"").toString().trim()!=="")); if(ok)cb(null,rows); else next();},
    error:()=>next()});
  tryEnc("utf-8",()=>tryEnc("gbk",()=>tryEnc("latin1",()=>cb(new Error("无法解析CSV"),null))));
}
function parseDN(s){const m=String(s||"").match(/DN\s*([0-9]+)/i);return m?parseInt(m[1],10):null;}
function sortByDN(rows){const t=rows.map((r)=>({dn:parseDN(r["项目名称"]),r})); if(!t.some(x=>x.dn!==null))return rows; t.sort((a,b)=>(a.dn??1e9)-(b.dn??1e9)); return t.map(x=>x.r);}
function num(v){if(v===null||v===undefined) return null; const s=String(v).replace(/,/g,"").trim(); const x=parseFloat(s); return isNaN(x)?null:x;}
function to2(x){return (Math.round(x*100)/100).toFixed(2);}

// ===== 录入区 =====
const tbody=document.getElementById("tbody");
function rowToTr(r={}){
  const cols=["项目名称","清单数量","图纸数量","统一系数单价","成本单价","最低报价"];
  const tr=document.createElement("tr");
  cols.forEach(c=>{
    const td=document.createElement("td");
    const inp=document.createElement("input");
    inp.type=(c==="项目名称"?"text":"number");
    if(inp.type==="number"){inp.step="0.01";inp.className="w-sm";}
    inp.value=(r[c]??"");
    td.appendChild(inp); tr.appendChild(td);
  });
  return tr;
}
function loadRows(rows){tbody.innerHTML=""; sortByDN(rows).forEach(r=>tbody.appendChild(rowToTr(r)));}
function getRows(){
  const rows=[];
  [...tbody.querySelectorAll("tr")].forEach(tr=>{
    const t=[...tr.querySelectorAll("td input")];
    const row={
      "项目名称": t[0].value.trim(),
      "清单数量": num(t[1].value),
      "图纸数量": num(t[2].value),
      "统一系数单价": num(t[3].value),
      "成本单价": num(t[4].value),
      "最低报价": num(t[5].value)
    };
    if(row["项目名称"]) rows.push(row);
  });
  return rows;
}
document.getElementById("btnAddRow").onclick=()=>tbody.appendChild(rowToTr({}));

// 上传 CSV → 填充表格
document.getElementById("file").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f)return;
  parseCSV(f,(err,rows)=>{
    if(err){alert(err.message);return;}
    const fixed=rows.map(r=>({
      "项目名称": r["项目名称"] ?? "",
      "清单数量": num(r["清单数量"]),
      "图纸数量": num(r["图纸数量"]),
      "统一系数单价": num(r["统一系数单价"]),
      "成本单价": num(r["成本单价"]),
      "最低报价": num(r["最低报价"])
    }));
    loadRows(fixed);
    document.getElementById("hint").textContent="已导入：可直接在表内继续编辑";
  });
});

// ===== 计算（内部用线性规划，但界面不暴露数学词） =====
function buildAndSolve(rows, tol, capPct){
  const n=rows.length; if(!n) throw new Error("没有数据行");
  // 基础校验：成本不能为空
  if(rows.some(r=>r["成本单价"]===null||isNaN(r["成本单价"]))){
    throw new Error("存在空的【成本单价】，请补全后再计算。");
  }

  const listQty = rows.map(r=>+r["清单数量"]    ||0);
  const drawQty = rows.map(r=>+r["图纸数量"]    ||0);
  const uprice  = rows.map(r=>+r["统一系数单价"]||0);
  const cost    = rows.map(r=>+r["成本单价"]);
  const minpRaw = rows.map(r=>r["最低报价"]);

  // 最终下限：max(成本, 最低报价(若空则视为成本))
  const floor = rows.map((_,i)=>{
    const m = (minpRaw[i]===null||isNaN(minpRaw[i])) ? cost[i] : +minpRaw[i];
    return Math.max(cost[i], m);
  });

  // 模型
  const model={optimize:"obj",opType:"max",constraints:{},variables:{}};
  // 清单口径允许差额
  const base = listQty.reduce((s,q,i)=>s+q*uprice[i],0);
  model.constraints["rep_up"]={max:base + (+tol||0)};
  model.constraints["rep_lo"]={max:(+tol||0) - base};

  // 单价不降 & 上限（百分比×下一档统一价）
  for(let i=1;i<n;i++) model.constraints[`mono_${i}`]={max:0};
  for(let i=0;i<n-1;i++) model.constraints[`cap_${i}`]={max: (+capPct/100)*uprice[i+1] };

  // 下限：-p_i <= -floor_i
  for(let i=0;i<n;i++) model.constraints[`floor_${i}`]={max:-floor[i]};

  // 变量（目标用图纸量）
  for(let i=0;i<n;i++){
    const name=`p_${i}`; const v={obj:drawQty[i]};
    v["rep_up"]=listQty[i]; v["rep_lo"]=-listQty[i];
    if(i<n-1) v[`cap_${i}`]=1;
    v[`floor_${i}`]=-1;
    model.variables[name]=v;
  }
  // 单调：p_{i-1} - p_i <= 0
  for(let i=1;i<n;i++){
    const prev=`p_${i-1}`, cur=`p_${i}`;
    model.variables[prev][`mono_${i}`]=(model.variables[prev][`mono_${i}`]||0)+1;
    model.variables[cur][`mono_${i}`]=(model.variables[cur][`mono_${i}`]||0)-1;
  }

  const res=solver.Solve(model);
  if(!res.feasible) throw new Error("当前规则下无解，请适当调大“允许差额”或“上限百分比”");

  const p=Array.from({length:n},(_,i)=>res[`p_${i}`]);

  // 输出表与合计
  const out=rows.map((r,i)=>{
    const lq=listQty[i], jq=drawQty[i], up=uprice[i], c=cost[i], pi=p[i];
    return {
      "项目名称": r["项目名称"],
      "清单数量": lq,
      "图纸数量": jq,
      "统一系数单价": up,
      "清单量*统一系数单价": lq*up,
      "建议报价": pi,
      "图纸量*成本": jq*c,
      "图纸量*建议报价": jq*pi,
      "清单量*建议报价": lq*pi
    };
  });

  const sumA = out.reduce((s,r)=>s+r["清单量*统一系数单价"],0);
  const sumB = out.reduce((s,r)=>s+r["清单量*建议报价"],0);
  const sumC = out.reduce((s,r)=>s+r["图纸量*成本"],0);
  const sumD = out.reduce((s,r)=>s+r["图纸量*建议报价"],0);

  return {out,sumA,sumB,sumC,sumD};
}

// 渲染结果表
function renderOutTable(rows){
  const tbl=document.getElementById("outTable");
  tbl.innerHTML="";
  if(!rows||!rows.length){tbl.innerHTML="<tr><td class='muted'>暂无结果</td></tr>";return;}
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本","图纸量*建议报价","清单量*建议报价"];
  const thead=document.createElement("thead"); const trh=document.createElement("tr");
  headers.forEach(h=>{const th=document.createElement("th"); th.textContent=h; trh.appendChild(th);}); thead.appendChild(trh); tbl.appendChild(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    headers.forEach(h=>{const td=document.createElement("td"); const v=r[h]; td.textContent=(typeof v==="number")?to2(v):v; tr.appendChild(td);});
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}

// 计算按钮
document.getElementById("btnSolve").onclick=()=>{
  try{
    const rows=getRows();
    if(!rows.length){alert("请先录入或导入数据");return;}
    const tol=+document.getElementById("tol").value||0;
    const capPct=+document.getElementById("capPct").value||100;

    const {out,sumA,sumB,sumC,sumD}=buildAndSolve(rows,tol,capPct);

    document.getElementById("sumA").textContent=to2(sumA);
    document.getElementById("sumB").textContent=to2(sumB);
    document.getElementById("sumC").textContent=to2(sumC);
    document.getElementById("sumD").textContent=to2(sumD);
    document.getElementById("diffAB").textContent=to2(sumB - sumA);
    document.getElementById("profit").textContent=to2(sumD - sumC);
    document.getElementById("summaryCards").style.display="";
    document.getElementById("summaryCards2").style.display="";
    document.getElementById("hint").textContent="计算完成";

    renderOutTable(out);
    window._outRows=out; document.getElementById("btnDownload").disabled=false;
  }catch(e){
    document.getElementById("hint").textContent=e.message||"计算失败";
    alert(e.message||e);
  }
};

// 下载 CSV
document.getElementById("btnDownload").onclick=()=>{
  const rows=window._outRows||[]; if(!rows.length)return;
  const headers=["项目名称","清单数量","图纸数量","统一系数单价","清单量*统一系数单价","建议报价","图纸量*成本单价","图纸量*建议报价","清单量*建议报价"];
  const csv=[headers.join(",")].concat(rows.map(r=>headers.map(h=>r[h]??"").join(","))).join("\n");
  const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="报价结果.csv"; a.click(); URL.revokeObjectURL(url);
};
</script>

</body>
</html>


